Only in ./libev-4.23/: aclocal.m4
Only in ./libev-4.23/: autogen.sh
Only in ./libev-4.23/: compile
Only in ./libev-4.23/: config.guess
Only in ./libev-4.23/: config.h
Only in ./libev-4.23/: config.h.in
Only in ./libev-4.23/: config.log
Only in ./libev-4.23/: config.status
Only in ./libev-4.23/: config.sub
Only in ./libev-4.23/: configure
Only in ./libev-4.23/: configure.ac
Only in ./libev-4.23/: depcomp
Only in ./libev-4.23/: .deps
Only in ./libev-4.23/: dist
Only in ./libev-4.23/: ev.3
diff -r ./libev-4.23/ev.c /home/jaruga/git/nio4r/ext/libev/ev.c
39a40,44
> /* ########## NIO4R PATCHERY HO! ########## */
> #include "ruby.h"
> #include "ruby/thread.h"
> /* ######################################## */
> 
3562a3568,3582
> /* ########## NIO4R PATCHERY HO! ########## */
> struct ev_poll_args {
>   struct ev_loop *loop;
>   ev_tstamp waittime;
> };
> 
> static
> VALUE ev_backend_poll(void *ptr)
> {
>   struct ev_poll_args *args = (struct ev_poll_args *)ptr;
>   struct ev_loop *loop = args->loop;
>   backend_poll (EV_A_ args->waittime);
> }
> /* ######################################## */
> 
3565a3586,3589
> /* ########## NIO4R PATCHERY HO! ########## */
>     struct ev_poll_args poll_args;
> /* ######################################## */
> 
3683c3707,3754
<         backend_poll (EV_A_ waittime);
---
> 
> /*
> ########################## NIO4R PATCHERY HO! ##########################
> 
> According to the grandwizards of Ruby, locking and unlocking of the global
> interpreter lock are apparently too powerful a concept for a mere mortal to
> wield (although redefining what + and - do to numbers is totally cool).
> And so it came to pass that the only acceptable way to release the global
> interpreter lock is through a convoluted callback system that thakes a
> function pointer. While the grandwizard of libev foresaw this sort of scenario,
> he too attempted to place an API with callbacks on it, one that runs before
> the system call, and one that runs immediately after.
> 
> And so it came to pass that trying to wrap everything up in callbacks created
> two incompatible APIs, Ruby's which releases the global interpreter lock and
> reacquires it when the callback returns, and libev's, which wants two
> callbacks, one which runs before the polling operation starts, and one which
> runs after it finishes.
> 
> These two systems are incompatible as they both want to use callbacks to
> solve the same problem, however libev wants to use before/after callbacks,
> and Ruby wants to use an "around" callback. This presents a significant
> problem as these two patterns of callbacks are diametrical opposites of each
> other and thus cannot be composed.
> 
> And thus we are left with no choice but to patch the internals of libev in
> order to release a mutex at just the precise moment.
> 
> This is a great example of a situation where granular locking and unlocking
> of the GVL is practically required. The goal is to get as close to the
> system call as possible, and to keep the GVL unlocked for the shortest
> amount of time possible.
> 
> Perhaps Ruby could benefit from such an API, e.g:
> 
> rb_thread_unsafe_dangerous_crazy_blocking_region_begin(...);
> rb_thread_unsafe_dangerous_crazy_blocking_region_end(...);
> 
> #######################################################################
> */
> 
>         poll_args.loop = loop;
>         poll_args.waittime = waittime;
>         rb_thread_call_without_gvl(ev_backend_poll, (void *)&poll_args, RUBY_UBF_IO, 0);
> /*
> ############################# END PATCHERY ############################
> */
> 
Only in ./libev-4.23/: event.c
Only in ./libev-4.23/: event.h
Only in ./libev-4.23/: event.lo
Only in ./libev-4.23/: event.o
Only in ./libev-4.23/: ev++.h
Only in ./libev-4.23/: ev.lo
Only in ./libev-4.23/: ev.o
Only in ./libev-4.23/: ev.pod
Only in ./libev-4.23/: install-sh
Only in ./libev-4.23/: libev.la
Only in ./libev-4.23/: libev.m4
Only in ./libev-4.23/: .libs
Only in ./libev-4.23/: libtool
Only in ./libev-4.23/: ltmain.sh
Only in ./libev-4.23/: Makefile
Only in ./libev-4.23/: Makefile.am
Only in ./libev-4.23/: Makefile.in
Only in ./libev-4.23/: missing
Only in ./libev-4.23/: mkinstalldirs
Only in /home/jaruga/git/nio4r/ext/libev/: README.embed
Only in ./libev-4.23/: stamp-h1
Only in ./libev-4.23/: Symbols.ev
Only in ./libev-4.23/: Symbols.event
Only in /home/jaruga/git/nio4r/ext/libev/: test_libev_win32.c
Only in ./libev-4.23/: TODO
